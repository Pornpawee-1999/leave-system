<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå BIOPHICS</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; background: #f0f4f8; min-height: 100vh; }
    .header { background: #06C755; color: white; padding: 16px 20px; font-size: 18px; font-weight: bold; }
    .profile-card { background: white; margin: 16px; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .profile-card img { width: 50px; height: 50px; border-radius: 50%; }
    .quota-card, .form-card { background: white; margin: 0 16px 16px; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .quota-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    .quota-item { background: #f8f9fa; border-radius: 8px; padding: 10px; text-align: center; }
    .quota-item .num { font-size: 22px; font-weight: bold; color: #06C755; }
    .quota-item .label { font-size: 11px; color: #666; margin-top: 2px; }
    .form-group { margin-bottom: 14px; }
    label { display: block; font-size: 13px; color: #555; margin-bottom: 4px; }
    select, input, textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    textarea { height: 80px; resize: none; }
    .btn-submit { width: 100%; background: #06C755; color: white; border: none; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .btn-submit:disabled { background: #ccc; }
    .error-msg { color: #e53e3e; font-size: 12px; margin-top: 4px; display: none; }
    .loading { text-align: center; padding: 40px; color: #666; }
  </style>
</head>
<body>

<div class="header">üåø ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå BIOPHICS</div>
<div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

<div id="main-content" style="display:none;">
  <div class="profile-card">
    <img id="profile-img" src="" alt="profile">
    <div>
      <h3 id="profile-name">-</h3>
      <p id="profile-position" style="font-size:13px;color:#666;">-</p>
    </div>
  </div>
  <div class="quota-card">
    <h4>üìÖ ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
    <div class="quota-grid">
      <div class="quota-item"><div class="num" id="q-sick">-</div><div class="label">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div></div>
      <div class="quota-item"><div class="num" id="q-personal">-</div><div class="label">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div></div>
      <div class="quota-item"><div class="num" id="q-vacation">-</div><div class="label">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</div></div>
      <div class="quota-item"><div class="num" id="q-maternity">-</div><div class="label">‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î/‡∏ö‡∏¥‡∏î‡∏≤</div></div>
    </div>
  </div>
  <div class="form-card">
    <h4>üìù ‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</h4>
    <div class="form-group">
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
      <select id="leave-type" onchange="updateQuotaDisplay()">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ --</option>
        <option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
        <option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
        <option value="‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
        <option value="‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î/‡∏•‡∏≤‡∏ö‡∏¥‡∏î‡∏≤">‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î/‡∏•‡∏≤‡∏ö‡∏¥‡∏î‡∏≤</option>
      </select>
    </div>
    <div class="form-group">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</label>
      <input type="date" id="start-date" onchange="calcDays()">
    </div>
    <div class="form-group">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
      <input type="date" id="end-date" onchange="calcDays()">
    </div>
    <div class="form-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£)</label>
      <input type="text" id="total-days" readonly placeholder="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" style="background:#f8f9fa;">
      <div class="error-msg" id="quota-error">‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</div>
    </div>
    <div class="form-group">
      <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
      <textarea id="reason" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."></textarea>
    </div>
    <button class="btn-submit" id="btn-submit" onclick="submitLeave()">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</button>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
<script>
  // ===== ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ =====
  const LIFF_ID = '2009263647-T2nMLmdi';
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxzkJsQqqUDD8bkb7FE6u4D5Rpw9p7QkUwqmnFgdEM0XOyUvRJ4bETjRDSnYEs3LeZG/exec';
  // ====================

  let userData = {};
  let quotaData = {};

  async function initLiff() {
    try {
      document.getElementById('loading').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...';
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      document.getElementById('loading').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
      const profile = await liff.getProfile();

      userData.lineUserId = profile.userId;
      userData.displayName = profile.displayName;
      userData.pictureUrl = profile.pictureUrl;
      document.getElementById('profile-img').src = profile.pictureUrl;

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GAS API
     function loadEmployee(lineUserId) {
  return new Promise((resolve) => {
    const callbackName = 'cb_' + Date.now();
    window[callbackName] = function(data) {
      delete window[callbackName];
      document.getElementById('jsonp-script')?.remove();
      resolve(data);
    };
    const script = document.createElement('script');
    script.id = 'jsonp-script';
    script.src = `${GAS_URL}?action=getEmployee&lineUserId=${lineUserId}&callback=${callbackName}`;
    document.body.appendChild(script);
  });
}

    } catch (e) {
      document.getElementById('loading').innerHTML = '‚ùå Error: ' + e.message;
    }
  }

  function onEmployeeLoaded(emp) {
    if (!emp || emp.error) {
      document.getElementById('loading').innerHTML =
        '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô<br><small>Line ID: ' + userData.lineUserId + '</small>';
      return;
    }
    userData.employeeId = emp.employee_id;
    quotaData = {
      '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢':         emp.quota_sick - emp.used_sick,
      '‡∏•‡∏≤‡∏Å‡∏¥‡∏à':          emp.quota_personal - emp.used_personal,
      '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô':     emp.quota_vacation - emp.used_vacation,
      '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î/‡∏•‡∏≤‡∏ö‡∏¥‡∏î‡∏≤': emp.quota_maternity - emp.used_maternity
    };
    document.getElementById('profile-name').textContent = emp.full_name;
    document.getElementById('profile-position').textContent = emp.position;
    document.getElementById('q-sick').textContent = quotaData['‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'];
    document.getElementById('q-personal').textContent = quotaData['‡∏•‡∏≤‡∏Å‡∏¥‡∏à'];
    document.getElementById('q-vacation').textContent = quotaData['‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô'];
    document.getElementById('q-maternity').textContent = quotaData['‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î/‡∏•‡∏≤‡∏ö‡∏¥‡∏î‡∏≤'];
    document.getElementById('loading').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
  }

  function calcDays() {
    const start = document.getElementById('start-date').value;
    const end   = document.getElementById('end-date').value;
    if (!start || !end) return;
    let count = 0;
    let current = new Date(start);
    const endDate = new Date(end);
    while (current <= endDate) {
      const day = current.getDay();
      if (day !== 0 && day !== 6) count++;
      current.setDate(current.getDate() + 1);
    }
    document.getElementById('total-days').value = count + ' ‡∏ß‡∏±‡∏ô';
    validateQuota(count);
  }

  function validateQuota(days) {
    const leaveType = document.getElementById('leave-type').value;
    const errorMsg  = document.getElementById('quota-error');
    const btn       = document.getElementById('btn-submit');
    if (!leaveType) return;
    const remaining = quotaData[leaveType] || 0;
    if (days > remaining) {
      errorMsg.style.display = 'block';
      btn.disabled = true;
    } else {
      errorMsg.style.display = 'none';
      btn.disabled = false;
    }
  }

  function updateQuotaDisplay() {
    const days = document.getElementById('total-days').value;
    if (days) validateQuota(parseInt(days));
  }

  async function submitLeave() {
    const leaveType = document.getElementById('leave-type').value;
    const startDate = document.getElementById('start-date').value;
    const endDate   = document.getElementById('end-date').value;
    const reason    = document.getElementById('reason').value;

    if (!leaveType || !startDate || !endDate || !reason) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
      return;
    }

    document.getElementById('btn-submit').disabled = true;
    document.getElementById('btn-submit').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'submitLeave',
          employeeId: userData.employeeId,
          leaveType, startDate, endDate, reason
        })
      });
      const result = await res.json();
      if (result.success) {
        alert('‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏´‡∏±‡∏™: ' + result.requestId + '\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ' + result.totalDays + ' ‡∏ß‡∏±‡∏ô');
        liff.closeWindow();
      } else {
        alert('‚ùå ' + result.message);
        document.getElementById('btn-submit').disabled = false;
        document.getElementById('btn-submit').textContent = '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤';
      }
    } catch (e) {
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
      document.getElementById('btn-submit').disabled = false;
      document.getElementById('btn-submit').textContent = '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤';
    }
  }

  initLiff();
</script>
</body>
</html>
